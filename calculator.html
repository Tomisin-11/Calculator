<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCal - Calculator Mode</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100'/><text y='70' x='50' text-anchor='middle' font-size='45' font-weight='900' fill='%23fff'>TC</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
        }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            z-index: 1000;
        }

        .logo {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #888888 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -2px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            color: #888888;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-link:hover {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            padding: 10px;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: #ffffff;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(8px, 8px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            flex-direction: column;
            gap: 10px;
            z-index: 999;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu .nav-link {
            width: 100%;
            text-align: center;
            padding: 15px;
        }

        /* Main Container */
        .container {
            margin-top: 70px;
            padding: 40px 20px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Mode Toggle */
        .mode-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .mode-toggle {
            display: flex;
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-btn {
            padding: 12px 32px;
            background: transparent;
            border: none;
            color: #888888;
            font-weight: 600;
            font-size: 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #ffffff;
            color: #000000;
        }

        /* Subject Selector */
        .subject-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
            animation: fadeInDown 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s backwards;
        }

        .section-divider {
            width: 100%;
            text-align: center;
            margin: 20px 0 16px 0;
        }

        .section-label {
            color: #666666;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .subject-chip {
            padding: 10px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 100px;
            color: #888888;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .subject-chip:hover {
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .subject-chip.active {
            background: #ffffff;
            color: #000000;
            border-color: #ffffff;
        }

        /* Topic Search & Dropdown */
        .topic-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
            animation: fadeInDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .topic-section.show {
            display: block;
        }

        /* Sticky Topic Info Bar */
        .sticky-topic-container {
            position: sticky;
            top: 70px;
            z-index: 900;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 40px;
            margin: 0 -40px 0 -40px;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .sticky-topic-container.show {
            display: block;
        }

        @keyframes stickySlide {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .sticky-topic-info {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .sticky-selected-subject {
            font-size: 13px;
            font-weight: 600;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sticky-arrow {
            color: #444444;
            font-size: 12px;
        }

        .sticky-selected-topic {
            display: inline-flex;
            align-items: center;
            background: rgba(0, 255, 136, 0.15);
            color: #00ff88;
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 13px;
            font-weight: 700;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .topic-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .topic-search {
            flex: 1;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.3s;
        }

        .topic-search:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.7);
        }

        .topic-search::placeholder {
            color: #555555;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 4px;
        }

        .topic-grid::-webkit-scrollbar {
            width: 6px;
        }

        .topic-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .topic-grid::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .topic-item {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #aaaaaa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            text-align: center;
            font-weight: 500;
        }

        .topic-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            color: #ffffff;
            transform: translateY(-2px);
        }

        .topic-item.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
            font-weight: 700;
        }

        .selected-topic-badge {
            display: inline-block;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 12px;
        }

        /* Calculator Layout */
        .calc-layout {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 40px;
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.2s backwards;
        }

        /* Calculator Panel */
        .calculator-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px;
            height: fit-content;
        }

        .display {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
            min-height: 120px;
        }

        .expression {
            color: #888888;
            font-size: 18px;
            margin-bottom: 12px;
            min-height: 30px;
            word-wrap: break-word;
        }

        .result {
            font-size: 42px;
            font-weight: 700;
            color: #ffffff;
            word-wrap: break-word;
        }

        /* Button Grid */
        .button-grid {
            display: grid;
            gap: 10px;
        }

        .simple-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .advanced-grid {
            grid-template-columns: repeat(5, 1fr);
        }

        .calc-btn {
            padding: 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .calc-btn:active {
            transform: translateY(0);
        }

        .calc-btn.operator {
            background: rgba(255, 255, 255, 0.1);
        }

        .calc-btn.equals {
            background: #ffffff;
            color: #000000;
            grid-column: span 2;
        }

        .calc-btn.clear {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6666;
        }

        .calc-btn.function {
            background: rgba(100, 150, 255, 0.15);
            font-size: 13px;
        }

        /* Explanation Panel */
        .explanation-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .explanation-panel::-webkit-scrollbar {
            width: 8px;
        }

        .explanation-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .explanation-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .explanation-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .explanation-content {
            color: #cccccc;
            line-height: 2;
            font-size: 16px;
        }

        .explanation-content strong {
            color: #ffffff;
            font-weight: 700;
            font-size: 17px;
        }

        .explanation-content h1,
        .explanation-content h2,
        .explanation-content h3 {
            color: #ffffff;
            font-weight: 800;
            margin-top: 24px;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .explanation-content h1 {
            font-size: 24px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 8px;
        }

        .explanation-content h2 {
            font-size: 20px;
        }

        .explanation-content h3 {
            font-size: 18px;
        }

        .explanation-content ul,
        .explanation-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .explanation-content li {
            margin: 8px 0;
            line-height: 1.8;
        }

        .explanation-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #00ff88;
            font-weight: 600;
        }

        .explanation-content p {
            margin: 12px 0;
        }

        .explanation-placeholder {
            color: #555555;
            text-align: center;
            padding: 60px 20px;
            font-size: 16px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #888888;
            padding: 40px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* View Explanation Button (Mobile) */
        .view-explanation-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ffffff;
            color: #000000;
            padding: 16px 24px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.3);
            cursor: pointer;
            z-index: 100;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            align-items: center;
            gap: 8px;
        }

        .view-explanation-btn.show {
            display: flex;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .view-explanation-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 50px rgba(255, 255, 255, 0.4);
        }

        .arrow-down {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-bottom: 3px solid #000000;
            border-right: 3px solid #000000;
            transform: rotate(45deg);
            animation: arrowBounce 1.5s infinite;
        }

        @keyframes arrowBounce {
            0%, 100% {
                transform: rotate(45deg) translateY(0);
            }
            50% {
                transform: rotate(45deg) translateY(5px);
            }
        }

        /* Image Upload Section */
        .image-upload-section {
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        .upload-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .upload-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .image-preview {
            margin-top: 16px;
            position: relative;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 100, 100, 0.9);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .remove-image:hover {
            background: rgba(255, 50, 50, 1);
            transform: scale(1.1);
        }

        .analyze-image-btn {
            margin-top: 12px;
            width: 100%;
            padding: 14px;
            background: #ffffff;
            color: #000000;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .analyze-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 255, 255, 0.3);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .calc-layout {
                grid-template-columns: 1fr;
            }

            .view-explanation-btn {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0 20px;
            }

            .nav-links {
                display: none;
            }

            .hamburger {
                display: flex;
            }

            .container {
                padding: 20px 15px;
            }

            .calculator-panel {
                padding: 20px;
            }

            .calc-btn {
                padding: 14px;
                font-size: 14px;
            }

            .calc-btn.function {
                font-size: 11px;
                padding: 12px 8px;
            }

            .result {
                font-size: 32px;
            }

            .mode-toggle {
                flex-direction: row;
                width: 100%;
            }

            .mode-btn {
                padding: 12px 20px;
                font-size: 12px;
            }

            .subject-chip {
                padding: 8px 16px;
                font-size: 12px;
            }

            .advanced-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .explanation-panel {
                margin-top: 40px;
            }

            .view-explanation-btn.show {
                display: flex !important;
            }

            .upload-buttons {
                flex-direction: column;
            }

            .upload-btn {
                width: 100%;
            }

            .sticky-topic-container {
                padding: 12px 20px;
                margin: 0 -20px 0 -20px;
            }

            .sticky-topic-info {
                font-size: 12px;
            }

            .sticky-selected-topic {
                font-size: 11px;
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo" onclick="window.location.href='index.html'">TCal</div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
            <a href="search.html" class="nav-link">Search</a>
        </div>
        <div class="hamburger" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="index.html" class="nav-link">Home</a>
        <a href="search.html" class="nav-link">Search</a>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Sticky Topic Info Bar -->
        <div class="sticky-topic-container" id="stickyTopicBar">
            <div class="sticky-topic-info">
                <span class="sticky-selected-subject" id="stickySubject"></span>
                <span class="sticky-arrow">‚Üí</span>
                <span class="sticky-selected-topic" id="stickyTopic"></span>
            </div>
        </div>

        <!-- Mode Toggle -->
        <div class="mode-toggle-container">
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="switchMode('simple')">Simple Mode</button>
                <button class="mode-btn" onclick="switchMode('advanced')">Advanced Mode</button>
                <button class="mode-btn" onclick="window.location.href='search.html'" style="background: rgba(0, 255, 136, 0.15); border: 1px solid rgba(0, 255, 136, 0.3); color: #00ff88;">
                    üîç Search Mode
                </button>
            </div>
        </div>

        <!-- Subject Selector -->
        <div class="subject-selector">
            <div class="section-divider" style="margin-top: 0;">
                <span class="section-label">Core Subjects</span>
            </div>
            <div class="subject-chip active" onclick="selectSubject('Mathematics')">Mathematics</div>
            <div class="subject-chip" onclick="selectSubject('Physics')">Physics</div>
            <div class="subject-chip" onclick="selectSubject('Chemistry')">Chemistry</div>
            <div class="subject-chip" onclick="selectSubject('Biology')">Biology</div>
            <div class="subject-chip" onclick="selectSubject('Statistics')">Statistics</div>
            
            <div class="section-divider">
                <span class="section-label">Advanced Courses</span>
            </div>
            <div class="subject-chip" onclick="selectSubject('Calculus')">Calculus</div>
            <div class="subject-chip" onclick="selectSubject('Linear Algebra')">Linear Algebra</div>
            <div class="subject-chip" onclick="selectSubject('Differential Equations')">Differential Equations</div>
            <div class="subject-chip" onclick="selectSubject('Thermodynamics')">Thermodynamics</div>
            <div class="subject-chip" onclick="selectSubject('Organic Chemistry')">Organic Chemistry</div>
            <div class="subject-chip" onclick="selectSubject('Quantum Mechanics')">Quantum Mechanics</div>
            <div class="subject-chip" onclick="selectSubject('Engineering')">Engineering</div>
            <div class="subject-chip" onclick="selectSubject('Computer Science')">Computer Science</div>
        </div>

        <!-- Topic Selection Section -->
        <div class="topic-section" id="topicSection">
            <div class="topic-header">
                <input type="text" id="topicSearch" class="topic-search" placeholder="Search topics..." onkeyup="filterTopics()">
                <span id="selectedTopicBadge"></span>
            </div>
            <div class="topic-grid" id="topicGrid">
                <!-- Topics will be populated by JavaScript -->
            </div>
        </div>

        <!-- Calculator Layout -->
        <div class="calc-layout">
            <!-- Calculator Panel -->
            <div class="calculator-panel">
                <div class="display">
                    <div class="expression" id="expression"></div>
                    <div class="result" id="result">0</div>
                </div>

                <!-- Simple Mode Buttons (Same for all subjects) -->
                <div class="button-grid simple-grid" id="simpleButtons">
                    <button class="calc-btn clear" onclick="clearCalc()">C</button>
                    <button class="calc-btn" onclick="backspace()">‚å´</button>
                    <button class="calc-btn operator" onclick="appendCalc('%')">%</button>
                    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
                    
                    <button class="calc-btn" onclick="appendCalc('7')">7</button>
                    <button class="calc-btn" onclick="appendCalc('8')">8</button>
                    <button class="calc-btn" onclick="appendCalc('9')">9</button>
                    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
                    
                    <button class="calc-btn" onclick="appendCalc('4')">4</button>
                    <button class="calc-btn" onclick="appendCalc('5')">5</button>
                    <button class="calc-btn" onclick="appendCalc('6')">6</button>
                    <button class="calc-btn operator" onclick="appendCalc('-')">‚àí</button>
                    
                    <button class="calc-btn" onclick="appendCalc('1')">1</button>
                    <button class="calc-btn" onclick="appendCalc('2')">2</button>
                    <button class="calc-btn" onclick="appendCalc('3')">3</button>
                    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                    
                    <button class="calc-btn" onclick="appendCalc('0')">0</button>
                    <button class="calc-btn" onclick="appendCalc('.')">.</button>
                    <button class="calc-btn equals" onclick="calculate()">=</button>
                </div>

                <!-- Advanced Mathematics -->
                <div class="button-grid advanced-grid" id="advancedMath" style="display: none;">
                    <button class="calc-btn clear" onclick="clearCalc()">C</button>
                    <button class="calc-btn" onclick="backspace()">‚å´</button>
                    <button class="calc-btn operator" onclick="appendCalc('**')">x^y</button>
                    <button class="calc-btn operator" onclick="appendCalc('Math.sqrt(')">‚àö</button>
                    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.sin(')">sin</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.cos(')">cos</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.tan(')">tan</button>
                    <button class="calc-btn" onclick="appendCalc('7')">7</button>
                    <button class="calc-btn" onclick="appendCalc('8')">8</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.asin(')">asin</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.acos(')">acos</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.atan(')">atan</button>
                    <button class="calc-btn" onclick="appendCalc('9')">9</button>
                    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.log(')">ln</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.log10(')">log</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.exp(')">e^x</button>
                    <button class="calc-btn" onclick="appendCalc('4')">4</button>
                    <button class="calc-btn" onclick="appendCalc('5')">5</button>
                    
                    <button class="calc-btn" onclick="appendCalc('(')">( </button>
                    <button class="calc-btn" onclick="appendCalc(')')">)</button>
                    <button class="calc-btn" onclick="appendCalc('Math.PI')">œÄ</button>
                    <button class="calc-btn" onclick="appendCalc('6')">6</button>
                    <button class="calc-btn operator" onclick="appendCalc('-')">‚àí</button>
                    
                    <button class="calc-btn" onclick="appendCalc('Math.E')">e</button>
                    <button class="calc-btn operator" onclick="appendCalc('%')">%</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.abs(')">|x|</button>
                    <button class="calc-btn" onclick="appendCalc('1')">1</button>
                    <button class="calc-btn" onclick="appendCalc('2')">2</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.cbrt(')">‚àõ</button>
                    <button class="calc-btn" onclick="appendCalc('**2')">x¬≤</button>
                    <button class="calc-btn" onclick="appendCalc('**3')">x¬≥</button>
                    <button class="calc-btn" onclick="appendCalc('3')">3</button>
                    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.floor(')">‚åäx‚åã</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.ceil(')">‚åàx‚åâ</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.round(')">round</button>
                    <button class="calc-btn" onclick="appendCalc('0')">0</button>
                    <button class="calc-btn" onclick="appendCalc('.')">.</button>
                    
                    <button class="calc-btn function" onclick="factorial()">n!</button>
                    <button class="calc-btn equals" style="grid-column: span 4;" onclick="calculate()">=</button>
                </div>

                <!-- Advanced Physics -->
                <div class="button-grid advanced-grid" id="advancedPhysics" style="display: none;">
                    <button class="calc-btn clear" onclick="clearCalc()">C</button>
                    <button class="calc-btn" onclick="backspace()">‚å´</button>
                    <button class="calc-btn operator" onclick="appendCalc('**')">x^y</button>
                    <button class="calc-btn operator" onclick="appendCalc('Math.sqrt(')">‚àö</button>
                    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('9.8*')">g</button>
                    <button class="calc-btn function" onclick="appendCalc('3e8*')">c</button>
                    <button class="calc-btn function" onclick="appendCalc('6.674e-11*')">G</button>
                    <button class="calc-btn" onclick="appendCalc('7')">7</button>
                    <button class="calc-btn" onclick="appendCalc('8')">8</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('6.626e-34*')">h</button>
                    <button class="calc-btn function" onclick="appendCalc('1.602e-19*')">e</button>
                    <button class="calc-btn function" onclick="appendCalc('9.109e-31*')">m_e</button>
                    <button class="calc-btn" onclick="appendCalc('9')">9</button>
                    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.sin(')">sin</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.cos(')">cos</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.tan(')">tan</button>
                    <button class="calc-btn" onclick="appendCalc('4')">4</button>
                    <button class="calc-btn" onclick="appendCalc('5')">5</button>
                    
                    <button class="calc-btn" onclick="appendCalc('(')">( </button>
                    <button class="calc-btn" onclick="appendCalc(')')">)</button>
                    <button class="calc-btn" onclick="appendCalc('Math.PI')">œÄ</button>
                    <button class="calc-btn" onclick="appendCalc('6')">6</button>
                    <button class="calc-btn operator" onclick="appendCalc('-')">‚àí</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('0.5*')">¬Ω</button>
                    <button class="calc-btn operator" onclick="appendCalc('%')">%</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.abs(')">|x|</button>
                    <button class="calc-btn" onclick="appendCalc('1')">1</button>
                    <button class="calc-btn" onclick="appendCalc('2')">2</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('1.38e-23*')">k_B</button>
                    <button class="calc-btn" onclick="appendCalc('**2')">x¬≤</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.log(')">ln</button>
                    <button class="calc-btn" onclick="appendCalc('3')">3</button>
                    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('8.854e-12*')">Œµ‚ÇÄ</button>
                    <button class="calc-btn function" onclick="appendCalc('4*Math.PI*1e-7*')">Œº‚ÇÄ</button>
                    <button class="calc-btn function" onclick="appendCalc('1.602e-19/')">eV‚ÜíJ</button>
                    <button class="calc-btn" onclick="appendCalc('0')">0</button>
                    <button class="calc-btn" onclick="appendCalc('.')">.</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.exp(')">e^x</button>
                    <button class="calc-btn equals" style="grid-column: span 4;" onclick="calculate()">=</button>
                </div>

                <!-- Advanced Chemistry -->
                <div class="button-grid advanced-grid" id="advancedChemistry" style="display: none;">
                    <button class="calc-btn clear" onclick="clearCalc()">C</button>
                    <button class="calc-btn" onclick="backspace()">‚å´</button>
                    <button class="calc-btn operator" onclick="appendCalc('**')">x^y</button>
                    <button class="calc-btn operator" onclick="appendCalc('Math.sqrt(')">‚àö</button>
                    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('6.022e23*')">N_A</button>
                    <button class="calc-btn function" onclick="appendCalc('8.314*')">R</button>
                    <button class="calc-btn function" onclick="appendCalc('0.0821*')">R(L)</button>
                    <button class="calc-btn" onclick="appendCalc('7')">7</button>
                    <button class="calc-btn" onclick="appendCalc('8')">8</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('96485*')">F</button>
                    <button class="calc-btn function" onclick="appendCalc('1.381e-23*')">k_B</button>
                    <button class="calc-btn function" onclick="appendCalc('273.15+')">¬∞C‚ÜíK</button>
                    <button class="calc-btn" onclick="appendCalc('9')">9</button>
                    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.log(')">ln</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.log10(')">log</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.exp(')">e^x</button>
                    <button class="calc-btn" onclick="appendCalc('4')">4</button>
                    <button class="calc-btn" onclick="appendCalc('5')">5</button>
                    
                    <button class="calc-btn" onclick="appendCalc('(')">( </button>
                    <button class="calc-btn" onclick="appendCalc(')')">)</button>
                    <button class="calc-btn function" onclick="appendCalc('-Math.log(')">-ln</button>
                    <button class="calc-btn" onclick="appendCalc('6')">6</button>
                    <button class="calc-btn operator" onclick="appendCalc('-')">‚àí</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('22.4*')">V_m</button>
                    <button class="calc-btn function" onclick="appendCalc('101325*')">P_atm</button>
                    <button class="calc-btn function" onclick="appendCalc('1.66e-27*')">u</button>
                    <button class="calc-btn" onclick="appendCalc('1')">1</button>
                    <button class="calc-btn" onclick="appendCalc('2')">2</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('10**-')">10^-x</button>
                    <button class="calc-btn" onclick="appendCalc('**2')">x¬≤</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.abs(')">|x|</button>
                    <button class="calc-btn" onclick="appendCalc('3')">3</button>
                    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                    
                    <button class="calc-btn operator" onclick="appendCalc('%')">%</button>
                    <button class="calc-btn function" onclick="appendCalc('1000*')">L‚ÜímL</button>
                    <button class="calc-btn function" onclick="appendCalc('/1000')">mL‚ÜíL</button>
                    <button class="calc-btn" onclick="appendCalc('0')">0</button>
                    <button class="calc-btn" onclick="appendCalc('.')">.</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.PI')">œÄ</button>
                    <button class="calc-btn equals" style="grid-column: span 4;" onclick="calculate()">=</button>
                </div>

                <!-- Advanced Statistics -->
                <div class="button-grid advanced-grid" id="advancedStatistics" style="display: none;">
                    <button class="calc-btn clear" onclick="clearCalc()">C</button>
                    <button class="calc-btn" onclick="backspace()">‚å´</button>
                    <button class="calc-btn operator" onclick="appendCalc('**')">x^y</button>
                    <button class="calc-btn operator" onclick="appendCalc('Math.sqrt(')">‚àö</button>
                    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.sqrt(Math.PI*2)*')">‚àö2œÄ</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.exp(-0.5*')">e^-¬Ω</button>
                    <button class="calc-btn function" onclick="appendCalc('1.96*')">z.95</button>
                    <button class="calc-btn" onclick="appendCalc('7')">7</button>
                    <button class="calc-btn" onclick="appendCalc('8')">8</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('2.576*')">z.99</button>
                    <button class="calc-btn function" onclick="appendCalc('1.645*')">z.90</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.log(')">ln</button>
                    <button class="calc-btn" onclick="appendCalc('9')">9</button>
                    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
                    
                    <button class="calc-btn" onclick="appendCalc('(')">( </button>
                    <button class="calc-btn" onclick="appendCalc(')')">)</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.exp(')">e^x</button>
                    <button class="calc-btn" onclick="appendCalc('4')">4</button>
                    <button class="calc-btn" onclick="appendCalc('5')">5</button>
                    
                    <button class="calc-btn function" onclick="factorial()">n!</button>
                    <button class="calc-btn function" onclick="combination()">nCr</button>
                    <button class="calc-btn function" onclick="permutation()">nPr</button>
                    <button class="calc-btn" onclick="appendCalc('6')">6</button>
                    <button class="calc-btn operator" onclick="appendCalc('-')">‚àí</button>
                    
                    <button class="calc-btn operator" onclick="appendCalc('%')">%</button>
                    <button class="calc-btn" onclick="appendCalc('**2')">x¬≤</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.abs(')">|x|</button>
                    <button class="calc-btn" onclick="appendCalc('1')">1</button>
                    <button class="calc-btn" onclick="appendCalc('2')">2</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('0.5*')">¬Ω</button>
                    <button class="calc-btn function" onclick="appendCalc('/Math.sqrt(')">√∑‚àö</button>
                    <button class="calc-btn function" onclick="appendCalc('1-')">1-x</button>
                    <button class="calc-btn" onclick="appendCalc('3')">3</button>
                    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                    
                    <button class="calc-btn" onclick="appendCalc('Math.PI')">œÄ</button>
                    <button class="calc-btn" onclick="appendCalc('Math.E')">e</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.pow(')">pow</button>
                    <button class="calc-btn" onclick="appendCalc('0')">0</button>
                    <button class="calc-btn" onclick="appendCalc('.')">.</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.log10(')">log</button>
                    <button class="calc-btn equals" style="grid-column: span 4;" onclick="calculate()">=</button>
                </div>

                <!-- Advanced Engineering -->
                <div class="button-grid advanced-grid" id="advancedEngineering" style="display: none;">
                    <button class="calc-btn clear" onclick="clearCalc()">C</button>
                    <button class="calc-btn" onclick="backspace()">‚å´</button>
                    <button class="calc-btn operator" onclick="appendCalc('**')">x^y</button>
                    <button class="calc-btn operator" onclick="appendCalc('Math.sqrt(')">‚àö</button>
                    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.sin(')">sin</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.cos(')">cos</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.tan(')">tan</button>
                    <button class="calc-btn" onclick="appendCalc('7')">7</button>
                    <button class="calc-btn" onclick="appendCalc('8')">8</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.log(')">ln</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.log10(')">log</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.exp(')">e^x</button>
                    <button class="calc-btn" onclick="appendCalc('9')">9</button>
                    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
                    
                    <button class="calc-btn" onclick="appendCalc('(')">( </button>
                    <button class="calc-btn" onclick="appendCalc(')')">)</button>
                    <button class="calc-btn" onclick="appendCalc('Math.PI')">œÄ</button>
                    <button class="calc-btn" onclick="appendCalc('4')">4</button>
                    <button class="calc-btn" onclick="appendCalc('5')">5</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.abs(')">|x|</button>
                    <button class="calc-btn" onclick="appendCalc('**2')">x¬≤</button>
                    <button class="calc-btn" onclick="appendCalc('**3')">x¬≥</button>
                    <button class="calc-btn" onclick="appendCalc('6')">6</button>
                    <button class="calc-btn operator" onclick="appendCalc('-')">‚àí</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.cbrt(')">‚àõ</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.pow(10,')">10^x</button>
                    <button class="calc-btn function" onclick="appendCalc('2*Math.PI*')">2œÄ</button>
                    <button class="calc-btn" onclick="appendCalc('1')">1</button>
                    <button class="calc-btn" onclick="appendCalc('2')">2</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('1/')">1/x</button>
                    <button class="calc-btn operator" onclick="appendCalc('%')">%</button>
                    <button class="calc-btn function" onclick="appendCalc('180/Math.PI*')">rad‚Üí¬∞</button>
                    <button class="calc-btn" onclick="appendCalc('3')">3</button>
                    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.PI/180*')">¬∞‚Üírad</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.floor(')">‚åäx‚åã</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.ceil(')">‚åàx‚åâ</button>
                    <button class="calc-btn" onclick="appendCalc('0')">0</button>
                    <button class="calc-btn" onclick="appendCalc('.')">.</button>
                    
                    <button class="calc-btn" onclick="appendCalc('Math.E')">e</button>
                    <button class="calc-btn equals" style="grid-column: span 4;" onclick="calculate()">=</button>
                </div>

                <!-- Advanced Biology -->
                <div class="button-grid advanced-grid" id="advancedBiology" style="display: none;">
                    <button class="calc-btn clear" onclick="clearCalc()">C</button>
                    <button class="calc-btn" onclick="backspace()">‚å´</button>
                    <button class="calc-btn operator" onclick="appendCalc('**')">x^y</button>
                    <button class="calc-btn operator" onclick="appendCalc('Math.sqrt(')">‚àö</button>
                    <button class="calc-btn operator" onclick="appendCalc('/')">√∑</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('6.022e23*')">N_A</button>
                    <button class="calc-btn function" onclick="appendCalc('3e9*')">bp</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.log(')">ln</button>
                    <button class="calc-btn" onclick="appendCalc('7')">7</button>
                    <button class="calc-btn" onclick="appendCalc('8')">8</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('Math.log10(')">log</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.exp(')">e^x</button>
                    <button class="calc-btn function" onclick="appendCalc('10**-')">10^-x</button>
                    <button class="calc-btn" onclick="appendCalc('9')">9</button>
                    <button class="calc-btn operator" onclick="appendCalc('*')">√ó</button>
                    
                    <button class="calc-btn" onclick="appendCalc('(')">( </button>
                    <button class="calc-btn" onclick="appendCalc(')')">)</button>
                    <button class="calc-btn operator" onclick="appendCalc('%')">%</button>
                    <button class="calc-btn" onclick="appendCalc('4')">4</button>
                    <button class="calc-btn" onclick="appendCalc('5')">5</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('0.5*')">¬Ω</button>
                    <button class="calc-btn function" onclick="appendCalc('0.25*')">¬º</button>
                    <button class="calc-btn function" onclick="appendCalc('0.75*')">¬æ</button>
                    <button class="calc-btn" onclick="appendCalc('6')">6</button>
                    <button class="calc-btn operator" onclick="appendCalc('-')">‚àí</button>
                    
                    <button class="calc-btn" onclick="appendCalc('**2')">x¬≤</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.abs(')">|x|</button>
                    <button class="calc-btn function" onclick="factorial()">n!</button>
                    <button class="calc-btn" onclick="appendCalc('1')">1</button>
                    <button class="calc-btn" onclick="appendCalc('2')">2</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('1000*')">ŒºL‚ÜínL</button>
                    <button class="calc-btn function" onclick="appendCalc('/1000')">mL‚ÜíŒºL</button>
                    <button class="calc-btn function" onclick="appendCalc('1e6*')">M‚ÜíŒºM</button>
                    <button class="calc-btn" onclick="appendCalc('3')">3</button>
                    <button class="calc-btn operator" onclick="appendCalc('+')">+</button>
                    
                    <button class="calc-btn function" onclick="appendCalc('273.15+')">¬∞C‚ÜíK</button>
                    <button class="calc-btn function" onclick="appendCalc('Math.pow(2,')">2^x</button>
                    <button class="calc-btn" onclick="appendCalc('Math.PI')">œÄ</button>
                    <button class="calc-btn" onclick="appendCalc('0')">0</button>
                    <button class="calc-btn" onclick="appendCalc('.')">.</button>
                    
                    <button class="calc-btn" onclick="appendCalc('Math.E')">e</button>
                    <button class="calc-btn equals" style="grid-column: span 4;" onclick="calculate()">=</button>
                </div>
            </div>

            <!-- Explanation Panel -->
            <div class="explanation-panel" id="explanationPanel">
                <div class="explanation-title">AI Explanation</div>
                <div id="explanationContent" class="explanation-placeholder">
                    Perform a calculation to see the AI-powered step-by-step explanation
                </div>
            </div>
        </div>
    </div>

    <!-- View Explanation Button (Mobile Only) -->
    <button class="view-explanation-btn" id="viewExplanationBtn" onclick="scrollToExplanation()">
        View Explanation
        <span class="arrow-down"></span>
    </button>

    <script>
        const apiKey = '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';
        let currentExpression = '';
        let currentSubject = 'Mathematics';
        let currentTopic = null;
        let currentMode = 'simple';
        let uploadedImage = null;

        // Comprehensive topics for each subject
        const subjectTopics = {
            'Mathematics': [
                'Algebra', 'Geometry', 'Trigonometry', 'Pre-Calculus', 'Number Theory',
                'Arithmetic', 'Fractions & Decimals', 'Percentages', 'Ratios & Proportions',
                'Exponents & Radicals', 'Polynomials', 'Quadratic Equations', 'Systems of Equations',
                'Inequalities', 'Functions', 'Graphing', 'Sequences & Series', 'Probability',
                'Combinatorics', 'Logarithms', 'Complex Numbers', 'Matrices'
            ],
            'Calculus': [
                'Limits', 'Derivatives', 'Integration', 'Differential Calculus', 'Integral Calculus',
                'Multivariable Calculus', 'Vector Calculus', 'Applications of Derivatives',
                'Chain Rule', 'Product Rule', 'Quotient Rule', 'Implicit Differentiation',
                'Related Rates', 'Optimization', 'Curve Sketching', 'Area Under Curves',
                'Volume of Solids', 'Arc Length', 'Surface Area', 'Partial Derivatives',
                'Multiple Integrals', 'Line Integrals', 'Green\'s Theorem', 'Stokes\' Theorem'
            ],
            'Physics': [
                'Mechanics', 'Kinematics', 'Dynamics', 'Energy & Work', 'Momentum',
                'Rotational Motion', 'Gravity', 'Oscillations', 'Waves', 'Sound',
                'Light & Optics', 'Electricity', 'Magnetism', 'Electromagnetism',
                'Circuits', 'Thermodynamics', 'Fluid Mechanics', 'Modern Physics',
                'Relativity', 'Atomic Physics', 'Nuclear Physics', 'Quantum Physics'
            ],
            'Chemistry': [
                'Atomic Structure', 'Periodic Table', 'Chemical Bonding', 'Stoichiometry',
                'Chemical Reactions', 'Acids & Bases', 'Redox Reactions', 'Thermochemistry',
                'Kinetics', 'Equilibrium', 'Solutions', 'Electrochemistry', 'Nuclear Chemistry',
                'Organic Compounds', 'Inorganic Compounds', 'Gas Laws', 'Molecular Geometry'
            ],
            'Organic Chemistry': [
                'Alkanes', 'Alkenes', 'Alkynes', 'Aromatic Compounds', 'Alcohols', 'Ethers',
                'Aldehydes', 'Ketones', 'Carboxylic Acids', 'Esters', 'Amines', 'Amides',
                'Polymers', 'Stereochemistry', 'Reaction Mechanisms', 'Substitution Reactions',
                'Elimination Reactions', 'Addition Reactions', 'Oxidation-Reduction',
                'Spectroscopy', 'NMR', 'IR Spectroscopy', 'Mass Spectrometry'
            ],
            'Biology': [
                'Cell Biology', 'Genetics', 'Evolution', 'Ecology', 'Anatomy', 'Physiology',
                'Molecular Biology', 'Biochemistry', 'Microbiology', 'Botany', 'Zoology',
                'Immunology', 'Neuroscience', 'Developmental Biology', 'DNA & RNA',
                'Protein Synthesis', 'Cellular Respiration', 'Photosynthesis', 'Mitosis & Meiosis'
            ],
            'Statistics': [
                'Descriptive Statistics', 'Probability Theory', 'Distributions', 'Normal Distribution',
                'Binomial Distribution', 'Poisson Distribution', 'Hypothesis Testing', 'Confidence Intervals',
                'Regression Analysis', 'Correlation', 'ANOVA', 'Chi-Square Tests', 't-Tests',
                'Sampling Methods', 'Central Limit Theorem', 'Standard Deviation', 'Variance',
                'Mean, Median, Mode', 'Percentiles & Quartiles', 'Z-Scores', 'P-Values'
            ],
            'Linear Algebra': [
                'Vectors', 'Matrices', 'Matrix Operations', 'Determinants', 'Eigenvalues & Eigenvectors',
                'Linear Transformations', 'Vector Spaces', 'Basis & Dimension', 'Inner Product Spaces',
                'Orthogonality', 'Diagonalization', 'Systems of Linear Equations', 'Gaussian Elimination',
                'LU Decomposition', 'QR Decomposition', 'Singular Value Decomposition'
            ],
            'Differential Equations': [
                'First Order ODEs', 'Second Order ODEs', 'Higher Order ODEs', 'Linear Equations',
                'Nonlinear Equations', 'Separable Equations', 'Exact Equations', 'Integrating Factors',
                'Homogeneous Equations', 'Bernoulli Equations', 'Laplace Transforms',
                'Systems of ODEs', 'Partial Differential Equations', 'Boundary Value Problems',
                'Initial Value Problems', 'Series Solutions', 'Numerical Methods'
            ],
            'Thermodynamics': [
                'Laws of Thermodynamics', 'Heat Transfer', 'Enthalpy', 'Entropy', 'Gibbs Free Energy',
                'Work & Energy', 'Heat Engines', 'Refrigeration Cycles', 'Phase Transitions',
                'Ideal Gas Law', 'Real Gases', 'Thermodynamic Processes', 'Carnot Cycle',
                'Otto Cycle', 'Diesel Cycle', 'Statistical Mechanics'
            ],
            'Quantum Mechanics': [
                'Wave-Particle Duality', 'Schr√∂dinger Equation', 'Wave Functions', 'Operators',
                'Quantum States', 'Uncertainty Principle', 'Quantum Tunneling', 'Harmonic Oscillator',
                'Hydrogen Atom', 'Angular Momentum', 'Spin', 'Quantum Entanglement',
                'Perturbation Theory', 'Time-Dependent Systems', 'Quantum Field Theory'
            ],
            'Engineering': [
                'Statics', 'Dynamics', 'Strength of Materials', 'Fluid Mechanics', 'Heat Transfer',
                'Control Systems', 'Signal Processing', 'Circuit Analysis', 'Digital Logic',
                'Mechanical Design', 'Structural Analysis', 'Materials Science', 'CAD/CAM',
                'Thermodynamics', 'Electromagnetics', 'Power Systems'
            ],
            'Computer Science': [
                'Algorithms', 'Data Structures', 'Programming', 'Object-Oriented Programming',
                'Databases', 'Operating Systems', 'Computer Networks', 'Artificial Intelligence',
                'Machine Learning', 'Computer Architecture', 'Software Engineering',
                'Complexity Theory', 'Automata Theory', 'Compilers', 'Cybersecurity',
                'Distributed Systems', 'Cloud Computing', 'Big O Notation', 'Sorting Algorithms',
                'Graph Theory', 'Trees', 'Hash Tables', 'Recursion'
            ]
        };

        const advancedButtonSets = {
            'Mathematics': 'advancedMath',
            'Calculus': 'advancedMath',
            'Linear Algebra': 'advancedMath',
            'Differential Equations': 'advancedMath',
            'Physics': 'advancedPhysics',
            'Thermodynamics': 'advancedPhysics',
            'Quantum Mechanics': 'advancedPhysics',
            'Chemistry': 'advancedChemistry',
            'Organic Chemistry': 'advancedChemistry',
            'Statistics': 'advancedStatistics',
            'Engineering': 'advancedEngineering',
            'Biology': 'advancedBiology',
            'Computer Science': 'advancedEngineering'
        };

        // Image Upload Functions
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage = e.target.result;
                    document.getElementById('previewImg').src = uploadedImage;
                    document.getElementById('imagePreview').classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        }

        function openCamera() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = handleImageUpload;
            input.click();
        }

        function removeImage() {
            uploadedImage = null;
            document.getElementById('imagePreview').classList.remove('show');
            document.getElementById('imageUpload').value = '';
        }

        async function analyzeImage() {
            if (!uploadedImage) {
                alert('Please upload or take a photo first!');
                return;
            }

            const explanationContent = document.getElementById('explanationContent');
            
            explanationContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>AI is analyzing your image...</span>
                </div>
            `;

            // Show view explanation button on mobile
            showViewExplanationBtn();

            try {
                // For now, we'll use a workaround: analyze the image using Groq's text model
                // with a detailed description prompt
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{
                            role: "user",
                            content: `You are a ${currentSubject} tutor. I have uploaded an image that likely contains a math problem, diagram, equation, or educational content related to ${currentSubject}. 

Since you cannot see the image directly, please provide:
1. A comprehensive guide on how to solve common ${currentSubject} problems
2. Step-by-step explanation of typical problem-solving approaches
3. Key formulas and concepts in ${currentSubject}
4. Tips for analyzing diagrams and graphs

Please make your response educational and detailed.`
                        }],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                const explanation = data.choices[0].message.content;
                explanationContent.innerHTML = `
                    <div class="explanation-content">
                        <p style="color: #ffaa00; margin-bottom: 16px;">‚ö†Ô∏è <strong>Note:</strong> Vision API is currently unavailable. Here's general guidance for ${currentSubject}:</p>
                        ${explanation.replace(/\n/g, '<br>')}
                        <p style="color: #888888; margin-top: 16px; font-size: 13px;">üí° <strong>Tip:</strong> Type your problem in the calculator or search box for accurate AI-powered solutions!</p>
                    </div>
                `;
                
            } catch (error) {
                explanationContent.innerHTML = `
                    <p style="color: #ff6666;">Error analyzing image: ${error.message}</p>
                    <p style="color: #888888; margin-top: 12px;">Please type your question in the search box or calculator for the best results.</p>
                `;
            }
        }

        // Scroll to Explanation (Mobile)
        function scrollToExplanation() {
            const explanationPanel = document.getElementById('explanationPanel');
            explanationPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showViewExplanationBtn() {
            if (window.innerWidth <= 768) {
                document.getElementById('viewExplanationBtn').classList.add('show');
            }
        }

        function hideViewExplanationBtn() {
            document.getElementById('viewExplanationBtn').classList.remove('show');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            menu.classList.toggle('active');
            hamburger.classList.toggle('active');
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Hide all advanced grids
            Object.values(advancedButtonSets).forEach(id => {
                document.getElementById(id).style.display = 'none';
            });

            if (mode === 'simple') {
                document.getElementById('simpleButtons').style.display = 'grid';
            } else {
                document.getElementById('simpleButtons').style.display = 'none';
                const advancedId = advancedButtonSets[currentSubject];
                document.getElementById(advancedId).style.display = 'grid';
            }
        }

        function selectSubject(subject) {
            currentSubject = subject;
            currentTopic = null; // Reset topic when changing subject
            
            document.querySelectorAll('.subject-chip').forEach(chip => chip.classList.remove('active'));
            event.target.classList.add('active');

            // Show topic section and populate topics
            const topicSection = document.getElementById('topicSection');
            topicSection.classList.add('show');
            populateTopics();

            // If in advanced mode, switch to correct advanced button set
            if (currentMode === 'advanced') {
                Object.values(advancedButtonSets).forEach(id => {
                    if(document.getElementById(id)) {
                        document.getElementById(id).style.display = 'none';
                    }
                });
                const advancedId = advancedButtonSets[currentSubject];
                if(advancedId && document.getElementById(advancedId)) {
                    document.getElementById(advancedId).style.display = 'grid';
                }
            }
        }

        function populateTopics() {
            const topicGrid = document.getElementById('topicGrid');
            const topics = subjectTopics[currentSubject] || [];
            
            topicGrid.innerHTML = topics.map(topic => 
                `<div class="topic-item" onclick="selectTopic('${topic}')">${topic}</div>`
            ).join('');

            document.getElementById('topicSearch').value = '';
            document.getElementById('selectedTopicBadge').innerHTML = '';
        }

        function selectTopic(topic) {
            currentTopic = topic;
            
            // Update active state
            document.querySelectorAll('.topic-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');

            // Show selected topic badge
            document.getElementById('selectedTopicBadge').innerHTML = 
                `<span class="selected-topic-badge">${topic}</span>`;
            
            // Update and show sticky bar
            document.getElementById('stickySubject').textContent = currentSubject;
            document.getElementById('stickyTopic').textContent = topic;
            document.getElementById('stickyTopicBar').classList.add('show');
        }

        // Handle scroll to show/hide sticky bar
        let lastScrollTop = 0;
        window.addEventListener('scroll', function() {
            if (currentTopic) {
                const stickyBar = document.getElementById('stickyTopicBar');
                const topicSection = document.getElementById('topicSection');
                const topicSectionRect = topicSection.getBoundingClientRect();
                
                // Show sticky bar when topic section scrolls past navbar
                if (topicSectionRect.bottom < 70) {
                    stickyBar.classList.add('show');
                } else {
                    stickyBar.classList.remove('show');
                }
            }
        });

        function filterTopics() {
            const searchTerm = document.getElementById('topicSearch').value.toLowerCase();
            const topicItems = document.querySelectorAll('.topic-item');
            
            topicItems.forEach(item => {
                const topicName = item.textContent.toLowerCase();
                if (topicName.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function appendCalc(value) {
            currentExpression += value;
            document.getElementById('expression').textContent = currentExpression;
        }

        function clearCalc() {
            currentExpression = '';
            document.getElementById('expression').textContent = '';
            document.getElementById('result').textContent = '0';
            document.getElementById('explanationContent').innerHTML = `
                <div class="explanation-placeholder">
                    Perform a calculation to see the AI-powered step-by-step explanation
                </div>
            `;
            hideViewExplanationBtn();
        }

        function backspace() {
            currentExpression = currentExpression.slice(0, -1);
            document.getElementById('expression').textContent = currentExpression || '';
            if (!currentExpression) {
                document.getElementById('result').textContent = '0';
            }
        }

        function factorial() {
            if (currentExpression) {
                const num = eval(currentExpression);
                let result = 1;
                for (let i = 2; i <= num; i++) {
                    result *= i;
                }
                currentExpression = result.toString();
                document.getElementById('expression').textContent = currentExpression;
                document.getElementById('result').textContent = result;
            }
        }

        function combination() {
            alert('Enter expression as: n then select nCr then r');
        }

        function permutation() {
            alert('Enter expression as: n then select nPr then r');
        }

        async function calculate() {
            if (!currentExpression) return;

            try {
                // Calculate result
                let expression = currentExpression.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/‚àí/g, '-');
                let result = eval(expression);
                document.getElementById('result').textContent = result;

                // Get AI explanation automatically
                await getAIExplanation();

            } catch (error) {
                document.getElementById('result').textContent = 'Error';
                document.getElementById('explanationContent').innerHTML = `
                    <p style="color: #ff6666;">Invalid expression. Please check your input.</p>
                `;
            }
        }

        async function getAIExplanation() {
            const explanationContent = document.getElementById('explanationContent');
            
            explanationContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>AI is analyzing your calculation...</span>
                </div>
            `;

            // Show view explanation button on mobile
            showViewExplanationBtn();

            try {
                const topicContext = currentTopic ? `Focus specifically on ${currentTopic} concepts.` : '';
                
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{
                            role: "user",
                            content: `You are a ${currentSubject} tutor. ${topicContext}

Explain this calculation step-by-step with clear reasoning:

${currentExpression}

Provide a detailed, educational explanation using this format:
- Use **bold text** for key concepts and important terms
- Break down into clear numbered steps
- Explain the reasoning behind each step
- Include relevant formulas or principles
- Make it easy to understand

Format your response with clear headings and structured explanations.`
                        }],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                const explanation = data.choices[0].message.content;
                
                // Format the explanation with better structure
                let formattedExplanation = explanation
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                    .replace(/\n\n/g, '</p><p>') // Paragraphs
                    .replace(/\n/g, '<br>') // Line breaks
                    .replace(/(\d+\.)/g, '<br><strong>$1</strong>') // Number lists
                    .replace(/^- /gm, '‚Ä¢ '); // Bullet points
                
                explanationContent.innerHTML = `
                    <div class="explanation-content">
                        <p>${formattedExplanation}</p>
                    </div>
                `;
                
            } catch (error) {
                explanationContent.innerHTML = `
                    <p style="color: #ff6666;">Error getting explanation: ${error.message}</p>
                `;
            }
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (e.key >= '0' && e.key <= '9' || e.key === '.') {
                appendCalc(e.key);
            } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
                appendCalc(e.key);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                calculate();
            } else if (e.key === 'Escape') {
                clearCalc();
            } else if (e.key === 'Backspace') {
                e.preventDefault();
                backspace();
            }
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            if (menu.classList.contains('active') && !menu.contains(e.target) && !hamburger.contains(e.target)) {
                menu.classList.remove('active');
                hamburger.classList.remove('active');
            }
        });
    </script>
</body>
</html>
